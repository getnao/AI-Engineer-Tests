unit_tests:
  - name: test_snowplow_event_count_last_uploaded_at
    model: snowplow_event_counts
    overrides:
      macros:
        is_incremental: true
    given:
      - input: ref('snowplow_gitlab_good_events_source')
        rows: 
          - {event_id: '123e4567-e89b-12d3-a456-426614174000', uploaded_at: '2023-05-01 12:00:00', app_id: 'gitlab', derived_tstamp: '2023-05-01 12:00:00'}
          - {event_id: '123e4567-e89b-12d3-a456-426614174000', uploaded_at: '2023-05-01 12:30:00', app_id: 'gitlab', derived_tstamp: '2023-05-01 12:30:00'}
          - {event_id: '223e4567-e89b-12d3-a456-426614174001', uploaded_at: '2023-05-01 13:00:00', app_id: 'gitlab', derived_tstamp: '2023-05-01 13:00:00'}
      - input: this
        rows:
          - {last_uploaded_at: '2023-04-30 23:59:59'}

    expect:
      rows:
        - {clean_event_id: '123e4567-e89b-12d3-a456-426614174000', event_count: 2, last_uploaded_at: '2023-05-01 12:30:00'}
        - {clean_event_id: '223e4567-e89b-12d3-a456-426614174001', event_count: 1, last_uploaded_at: '2023-05-01 13:00:00'}
    
  - name: test_snowplow_event_count_event_filtering
    model: snowplow_event_counts
    overrides:
      macros:
        is_incremental: true
    given:
      - input: ref('snowplow_gitlab_good_events_source')
        rows: 
          - {event_id: 'invalid-event-id', uploaded_at: '2023-05-01 12:00:00', app_id: 'gitlab', derived_tstamp: '2023-05-01 12:00:00'}
          - {event_id: '123e4567-e89b-12d3-a456-426614174000', uploaded_at: '2023-05-01 12:30:00', app_id: 'gitlab', derived_tstamp: '2023-05-01 12:30:00'}
          - {event_id: '123e4567-e89b-12d3-a456-426614174001', uploaded_at: '2023-05-01 12:45:00', app_id: null, derived_tstamp: '2023-05-01 12:45:00'}
          - {event_id: '123e4567-e89b-12d3-a456-426614174002', uploaded_at: '2023-05-01 13:00:00', app_id: 'gitlab', derived_tstamp: null}
          - {event_id: '123e4567-e89b-12d3-a456-426614174000', uploaded_at: '2023-05-01 13:15:00', app_id: 'gitlab', derived_tstamp: '2023-05-01 13:15:00'}
      - input: this
        rows:
          - {last_uploaded_at: '2023-04-30 23:59:59'}

    expect:
      rows:
        - {clean_event_id: '123e4567-e89b-12d3-a456-426614174000', event_count: 2, last_uploaded_at: '2023-05-01 13:15:00'}